<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Professional Session Player</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.js"></script>
    <style>
        body { font-family: 'Helvetica Neue', Arial, sans-serif; text-align: center; background-color: #f0f2f5; padding: 10px; color: #333; }
        .container { max-width: 900px; margin: 0 auto; }
        .controls { 
            background: white; padding: 15px; border-radius: 15px; 
            box-shadow: 0 4px 12px rgba(0,0,0,0.1); 
            position: sticky; top: 10px; z-index: 100; margin-bottom: 20px;
        }
        select { font-size: 18px; padding: 10px; margin-bottom: 10px; width: 95%; border-radius: 8px; border: 1px solid #ccc; }
        .key-display { font-size: 20px; font-weight: bold; margin: 5px 0; color: #2c3e50; }
        .key-value { color: #e74c3c; padding: 0 5px; }
        .player-controls { margin-top: 10px; padding-top: 10px; border-top: 1px solid #eee; }
        
        button { font-size: 14px; padding: 10px 15px; cursor: pointer; margin: 3px; border-radius: 10px; border: none; background: #3498db; color: white; transition: 0.2s; }
        button:active { transform: scale(0.95); }
        .play-btn { background: #27ae60 !important; font-weight: bold; width: 160px; }
        .stop-btn { background: #c0392b !important; }
        .reset { background: #e67e22 !important; }

        .chord-sheet { background: white; padding: 20px 10px; border-radius: 15px; box-shadow: 0 6px 20px rgba(0,0,0,0.1); text-align: left; }
        .section-mark { display: inline-block; border: 2px solid #333; padding: 2px 10px; font-size: 16px; font-weight: bold; margin: 15px 0 8px 5px; background-color: #333; color: white; border-radius: 4px; }
        
        .grid-row { display: grid; grid-template-columns: repeat(4, 1fr); margin-bottom: 12px; }
        .flex-row-c { display: grid; grid-template-columns: 1fr 1fr 1fr 1fr 0.5fr; margin-bottom: 12px; }

        .measure { 
            border-left: 2px solid #444; padding: 20px 2px; min-height: 60px;
            display: flex; justify-content: center; align-items: baseline; gap: 4px; position: relative;
            background-color: #fff;
        }
        .measure:last-child { border-right: 2px solid #444; }
        
        /* ルート音（音階）のスタイル修正 */
        .root { 
            font-size: 36px; /* 視認性のため少しだけ大きく */
            font-weight: 400; /* 太字(900)から標準(400)に変更 */
            color: #e74c3c;
            line-height: 1;
        }
        /* 属性（m7, dimなど）のスタイル修正 */
        .suffix { 
            font-size: 20px; 
            font-weight: 500; /* 少しだけ存在感を出すために中太に */
            color: #444;
            margin-left: 1px;
        }

        .active-measure { background-color: #e3f2fd !important; box-shadow: inset 0 0 10px rgba(52, 152, 219, 0.3); }
        .short-measure { background-color: #fff9e6; border-right: 2px solid #444; }
        .two-beat::after { content: "2B"; position: absolute; top: 2px; right: 4px; font-size: 10px; color: #d63031; font-weight: bold; }
        
        .separator { height: 1px; background-color: #ddd; margin: 15px 0; }
        .separator-mid { height: 5px; background-color: #2c3e50; margin: 25px 0; border-radius: 3px; }

        @media (max-width: 480px) {
            .root { font-size: 24px; }
            .suffix { font-size: 15px; }
            .measure { padding: 15px 1px; min-height: 50px; }
        }
    </style>
</head>
<body>

<div class="container">
    <div class="controls">
        <select id="song-select" onchange="loadSong()">
            <option value="georgia">Georgia On My Mind</option>
            <option value="lovely">Isn't She Lovely</option>
            <option value="chicken">The Chicken</option>
            <option value="two-of-us">Just the two of us</option>
        </select>
        <div class="key-display">キー：<span id="current-key-name" class="key-value">-</span></div>
        <button onclick="changeKey(1)">＋ 上げる</button>
        <button onclick="changeKey(-1)">－ 下げる</button>
        <button class="reset" onclick="resetKey()">リセット</button>

        <div class="player-controls">
            BPM: <input type="number" id="bpm" style="width:60px; font-size: 16px;" value="70">
            <button id="play-btn" class="play-btn" onclick="togglePlay()" disabled>読込中...</button>
            <button class="stop-btn" onclick="stopAudio()">ストップ</button>
            <div id="status" style="font-size: 12px; color: #888; margin-top: 8px;">音源をダウンロード中...</div>
        </div>
    </div>
    <div id="sheet-area" class="chord-sheet"></div>
</div>

<script>
    const displayScale = ['C', 'Db', 'D', 'Eb', 'E', 'F', 'Gb', 'G', 'Ab', 'A', 'Bb', 'B'];
    const calcScale = ['C', 'C#', 'D', 'D#', 'E', 'F', 'F#', 'G', 'G#', 'A', 'A#', 'B'];
    
    let currentShift = 0;
    let originalSongKey = "G";
    let isPlaying = false;

    const reverb = new Tone.Reverb({ decay: 4, wet: 0.4 }).toDestination();
    const sampler = new Tone.Sampler({
        urls: {
            A0: "A0.mp3", C1: "C1.mp3", "D#1": "Ds1.mp3", "F#1": "Fs1.mp3", A1: "A1.mp3",
            C2: "C2.mp3", "D#2": "Ds2.mp3", "F#2": "Fs2.mp3", A2: "A2.mp3",
            C3: "C3.mp3", "D#3": "Ds3.mp3", "F#3": "Fs3.mp3", A3: "A3.mp3",
            C4: "C4.mp3", "D#4": "Ds4.mp3", "F#4": "Fs4.mp3", A4: "A4.mp3",
            C5: "C5.mp3", "D#5": "Ds5.mp3", "F#5": "Fs5.mp3", A5: "A5.mp3",
            C6: "C6.mp3"
        },
        release: 1.5,
        baseUrl: "https://tonejs.github.io/audio/salamander/",
        onload: () => {
            document.getElementById('play-btn').disabled = false;
            document.getElementById('play-btn').innerText = "演奏スタート";
            document.getElementById('status').innerText = "準備完了";
        }
    }).connect(reverb);

    const songs = {
        georgia: { key: "G", chords: [
            {section: "A", row: ["G", "B7", "Em G7", "C C#dim7"]}, {row: ["G E7", "A7 D7", "F7 E7", "A7 D7"]}, "sep",
            {row: ["G", "B7", "Em G7", "C C#dim7"]}, {row: ["G E7", "A7 D7", "G C7", "G B7"]}, "sep-mid",
            {section: "B", row: ["Em Em6", "Em6 Em6", "Em Em6", "Em7 A7"]}, {row: ["Em Em6", "Em F#7", "Bm7 Bb7", "A7 D7"]}, "sep",
            {section: "A", row: ["G", "B7", "Em G7", "C C#dim7"]}, {row: ["G E7", "A7 D7", "F7 E7", "A7 D7"]}
        ]},
        lovely: { key: "E", chords: [
            {section: "A", row: ["C#m7", "F#7", "B7sus4", "E"]}, {row: ["C#m7", "F#7", "B7sus4", "E"]}, "sep",
            {section: "B", row: ["AM7", "G#7", "C#m7", "F#7"]}, {row: ["B7sus4", "B7sus4", "E", "E"]}
        ]},
        chicken: { key: "Bb", chords: [
            {section: "Main", row: ["Bb7", "Bb7", "Bb7", "Bb7"]}, {row: ["Eb7", "Eb7", "D7", "G7"]}, "sep",
            {row: ["C7", "C7", "C7", "C7"]}, {row: ["Bb7", "Bb7", "Bb7", "Bb7"]}
        ]},
        "two-of-us": { key: "Ab", chords: [
            {section: "A", row: ["C#M7 C7", "Fm7 D#m7 G#7", "C#M7 C7", "Fm7"]}, "sep",
            {section: "B", row: ["C#M7 C7", "Fm7 Em7 D#m7 G#7", "C#M7 C7", "Fm7"]}, "sep",
            {section: "C", row: ["C#M7 C7", "BM7 BbM7", "AM7 AbM7", "DbM7 Gb6"]},
            {isCfinal: true, row: ["C#M7 C7", "BM7 BbM7", "AM7 AbM7", "DbM7 Gb6", {chord: "F#6", beats: 2}]}
        ]}
    };

    function getChordNotes(chordText) {
        const rootMatch = chordText.match(/^([A-G][#b]?)/);
        if (!rootMatch) return [];
        let root = rootMatch[1].replace('Bb','A#').replace('Eb','D#').replace('Ab','G#').replace('Db','C#').replace('Gb','F#');
        let idx = (calcScale.indexOf(root) + currentShift) % 12;
        if (idx < 0) idx += 12;
        let rootIdx = idx;

        const isMinor = chordText.includes('m') && !chordText.includes('M');
        const is7th = chordText.includes('7');
        const isMajor7 = chordText.includes('M7');
        const isDim = chordText.includes('dim');

        let notes = [calcScale[rootIdx] + "2", calcScale[(rootIdx + (isDim ? 6 : 7)) % 12] + "3", calcScale[(rootIdx + (isMinor || isDim ? 3 : 4)) % 12] + "4"];
        if (is7th) notes.push(calcScale[(rootIdx + (isMajor7 ? 11 : (isDim ? 9 : 10))) % 12] + "4");
        return notes;
    }

    function togglePlay() {
        if (isPlaying) { stopAudio(); return; }
        Tone.start();
        isPlaying = true;
        document.getElementById('play-btn').innerText = "一時停止";
        Tone.Transport.bpm.value = document.getElementById('bpm').value;
        Tone.Transport.cancel();

        const allMeasures = document.querySelectorAll('.measure');
        let currentTime = 0;

        allMeasures.forEach((mDiv) => {
            const chords = Array.from(mDiv.querySelectorAll('.chord-box')).map(el => el.dataset.fullChord);
            const isShort = mDiv.classList.contains('short-measure');
            const measureDur = isShort ? "2n" : "1n";
            
            Tone.Transport.schedule((time) => {
                Tone.Draw.schedule(() => {
                    allMeasures.forEach(m => m.classList.remove('active-measure'));
                    mDiv.classList.add('active-measure');
                }, time);
            }, currentTime);

            if (chords.length === 1) {
                Tone.Transport.schedule((time) => { sampler.triggerAttackRelease(getChordNotes(chords[0]), "2n", time); }, currentTime);
            } else if (chords.length === 2) {
                Tone.Transport.schedule((time) => { sampler.triggerAttackRelease(getChordNotes(chords[0]), "4n", time); }, currentTime);
                Tone.Transport.schedule((time) => { sampler.triggerAttackRelease(getChordNotes(chords[1]), "4n", time); }, currentTime + (isShort ? Tone.Time("4n").toSeconds() : Tone.Time("2n").toSeconds()));
            }
            currentTime += Tone.Time(measureDur).toSeconds();
        });
        Tone.Transport.start();
    }

    function stopAudio() {
        isPlaying = false;
        Tone.Transport.stop();
        document.getElementById('play-btn').innerText = "演奏スタート";
        document.querySelectorAll('.measure').forEach(m => m.classList.remove('active-measure'));
    }

    function loadSong() {
        const songId = document.getElementById('song-select').value;
        const song = songs[songId] || songs['georgia'];
        originalSongKey = song.key;
        currentShift = 0;
        renderSheet(song.chords);
        updateDisplay();
    }

    function renderSheet(data) {
        const area = document.getElementById('sheet-area');
        area.innerHTML = "";
        data.forEach(item => {
            if (typeof item === "string") {
                const div = document.createElement('div');
                div.className = (item === "sep-mid") ? "separator-mid" : "separator";
                area.appendChild(div);
            } else {
                if (item.section) {
                    const sec = document.createElement('div');
                    sec.className = "section-mark";
                    sec.innerText = item.section;
                    area.appendChild(sec);
                }
                const rowDiv = document.createElement('div');
                rowDiv.className = item.isCfinal ? "flex-row-c" : "grid-row";
                item.row.forEach(measureData => {
                    const mDiv = document.createElement('div');
                    let text = typeof measureData === "string" ? measureData : measureData.chord;
                    mDiv.className = typeof measureData === "string" ? "measure" : "measure short-measure two-beat";
                    
                    text.split(/\s+/).forEach(part => {
                        const match = part.match(/^([A-G][#b]?)(.*)/);
                        if (match) {
                            const rootCalc = match[1].replace('Bb','A#').replace('Eb','D#').replace('Ab','G#').replace('Db','C#').replace('Gb','F#');
                            mDiv.innerHTML += `<span class="chord-box" data-root="${rootCalc}" data-full-chord="${part}"><span class="root"></span><span class="suffix">${match[2]}</span></span>`;
                        }
                    });
                    rowDiv.appendChild(mDiv);
                });
                area.appendChild(rowDiv);
            }
        });
    }

    function changeKey(n) { currentShift += n; updateDisplay(); }
    function resetKey() { currentShift = 0; updateDisplay(); }
    
    function updateDisplay() {
        const keyDisplay = document.getElementById('current-key-name');
        const rootCalc = originalSongKey.replace('Bb','A#').replace('Eb','D#').replace('Ab','G#').replace('Db','C#').replace('Gb','F#');
        let newKeyIdx = (calcScale.indexOf(rootCalc) + currentShift) % 12;
        if (newKeyIdx < 0) newKeyIdx += 12;
        keyDisplay.innerText = displayScale[newKeyIdx];

        document.querySelectorAll('.chord-box').forEach(el => {
            let index = calcScale.indexOf(el.dataset.root);
            let nIdx = (index + currentShift) % 12;
            if (nIdx < 0) nIdx += 12;
            el.querySelector('.root').innerText = displayScale[nIdx];
        });
    }
    loadSong();
</script>
</body>
</html>
